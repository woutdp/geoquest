<script lang="ts">
    import * as turf from '@turf/turf'
    import {polyfillCountryFlagEmojis} from 'country-flag-emoji-polyfill'
    import * as d3 from 'd3'
    import {geoMiller, geoPatterson, geoRobinson} from 'd3-geo-projection'
    import _ from 'lodash'
    import {onMount} from 'svelte'

    import Map from '$lib/map/Map.svelte'
    import OlMap from '$lib/map/OlMap.svelte'
    import {clientX, clientY, day, geojson, mousePos, save, soundEffects, tags, topojson} from '$lib/store'
    import DebugInterface from '$lib/ui/DebugInterface.svelte'
    import LoadingScreen from '$lib/ui/LoadingScreen.svelte'
    import MouseTooltip from '$lib/ui/MouseTooltip.svelte'
    import UI from '$lib/ui/UI.svelte'
    import {achieveAchievement, ALREADY_GUESSED, CORRECT, getGeojsonByName, getTags, preprocessTopojson, processAchievements, WRONG} from '$lib/utils'

    polyfillCountryFlagEmojis()
    import dailyQuestCountries from '$lib/assets/data/daily-quest.json'

    const dev = import.meta.env.DEV

    let projections = [
        {func: geoPatterson(), name: 'Patterson'},
        {func: geoRobinson(), name: 'Robinson'},
        {func: geoMiller(), name: 'Miller'},
        {func: d3.geoMercator(), name: 'Mercator'},
        {func: d3.geoOrthographic(), name: 'Globe'}
    ]

    let projection = projections[0].func
    let questionFeature
    let lastFocusedCountry
    let focusedCountry
    let foundFeatures = []
    let unfoundFeatures = []
    let toFind = []
    let originalToFind = []
    let correctCountries = []
    let streak = 0
    let mistakes = 0
    let mistakesThisGuess = 0
    let successSound: HTMLAudioElement
    let interfaceLoaded = false
    let showMenu: boolean
    let showWinScreen = false
    let showDebug = false
    let ui
    let map
    let gameConfiguration = {
        mode: 'dailyQuest',
        countries: dailyQuestCountries[$day % 999],
        randomize: false,
        possibleCountries: 'all',
        restart: false,
        maxGuesses: 5
    }

    $: showLoadingScreen = Boolean(!$topojson)
    $: correct = correctCountries.length
    $: canRestart = gameConfiguration.restart ?? true

    function pickFeature() {
        const possibilities = _(toFind).filter(feature => feature !== questionFeature)
        questionFeature = gameConfiguration.randomize ?? true ? possibilities.sample() : possibilities.value()[0]
    }

    function restart() {
        showWinScreen = false
        mistakes = 0
        mistakesThisGuess = 0
        streak = 0
        toFind = originalToFind
        foundFeatures = []
        correctCountries = []

        if (gameConfiguration.possibleCountries === 'all') unfoundFeatures = $topojson.objects.countries.geometries
        else unfoundFeatures = toFind

        questionFeature = undefined
        pickFeature()
    }

    function newGame(configuration) {
        gameConfiguration = configuration
        toFind = _($topojson.objects.countries.geometries)
            .filter(geometry => configuration.countries.includes(geometry.properties.name))
            .sortBy(g => _(configuration.countries).findIndex(c => c === g.properties.name))
            .value()
        originalToFind = toFind

        if (configuration?.restart ?? true) restart()

        if (configuration?.mode === 'dailyQuest') {
            const progress = $save.dailyQuestProgress.progress

            if (gameConfiguration.possibleCountries === 'all') unfoundFeatures = $topojson.objects.countries.geometries
            else unfoundFeatures = toFind

            const alreadyFound = _(progress)
                .filter(arr => configuration.countries.includes(arr.slice(-1)[0]))
                .map(arr => arr.slice(-1)[0])
                .value()

            foundFeatures = alreadyFound
            correctCountries = _(progress)
                .filter(arr => arr.length === 1)
                .map(arr => arr[0])
                .value()

            mistakes = _(progress)
                .flatten()
                .reject(c => configuration.countries.includes(c))
                .value().length

            if (alreadyFound.length === progress.length) mistakesThisGuess = 0
            else mistakesThisGuess = _(progress.slice(-1)[0]).difference(configuration.countries).value().length

            if (mistakesThisGuess > 0) streak = 0
            else {
                const i = _(progress)
                    .map(arr => arr.length)
                    .reverse()
                    .findIndex(c => c !== 1)
                if (i === -1) streak = progress.length
                else streak = i
            }

            toFind = _($topojson.objects.countries.geometries)
                .filter(geometry =>
                    _(configuration.countries)
                        .reject(c => alreadyFound.includes(c))
                        .value()
                        .includes(geometry.properties.name)
                )
                .sortBy(g => _(configuration.countries).findIndex(c => c === g.properties.name))
                .value()

            if (toFind.length !== 0) {
                questionFeature = undefined
                pickFeature()
            } else {
                unfoundFeatures = []
                showMenu = true
                showWinScreen = true
            }
        }
    }

    function newDailyQuest() {
        if ($save?.dailyQuestProgress?.day !== $day) $save.dailyQuestProgress = {...$save.dailyQuestProgress, progress: [], day: $day}

        newGame({
            mode: 'dailyQuest',
            countries: dailyQuestCountries[$day % 999],
            randomize: false,
            possibleCountries: 'all',
            restart: false,
            maxGuesses: 5
        })
    }

    function clickCountryHandler(feature) {
        if (foundFeatures.includes(feature)) return ALREADY_GUESSED
        if (!unfoundFeatures.includes(feature)) return ALREADY_GUESSED

        if (questionFeature?.properties?.name === feature.properties.name) {
            if ($soundEffects) successSound.play()

            if (gameConfiguration.mode === 'dailyQuest') logGuess(feature.properties.name)

            foundFeatures = [...foundFeatures, feature]
            unfoundFeatures = _.filter(unfoundFeatures, e => e.properties.name !== feature.properties.name)
            toFind = _.filter(toFind, e => e.properties.name !== feature.properties.name)

            pickFeature()

            if (mistakesThisGuess === 0) correctCountries = [...correctCountries, feature.properties.name]

            mistakesThisGuess = 0
            streak += 1
            ui.triggerArrow()

            if (toFind.length === 0) {
                showMenu = true
                showWinScreen = true
                focusedCountry = undefined
                unfoundFeatures = []
                if (mistakes === 0 && gameConfiguration.mode === 'dailyQuest') achieveAchievement('daily-challenge')
            }

            achieveAchievement('1-country')
            if (streak === 5) achieveAchievement('5-streak')
            if (streak === 10) achieveAchievement('10-streak')
            if (streak === 30) achieveAchievement('30-streak')
            processAchievements(correctCountries)

            return CORRECT
        }

        const bearing = turf.bearingToAzimuth(
            turf.rhumbBearing(
                getGeojsonByName($geojson, feature.properties.name).properties.center.geometry.coordinates,
                getGeojsonByName($geojson, questionFeature.properties.name).properties.center.geometry.coordinates
            )
        )

        ui.triggerArrow(bearing)

        if (gameConfiguration.mode === 'dailyQuest') logGuess(feature.properties.name)

        mistakesThisGuess += 1
        mistakes += 1
        streak = 0
        return WRONG
    }

    function countryFocusedHandler(feature = undefined) {
        if (feature) lastFocusedCountry = feature
        focusedCountry = feature
    }

    function logGuess(country) {
        let progress = $save?.dailyQuestProgress?.progress ?? []
        const guess = foundFeatures.length
        progress[guess] = [...(progress[guess] ?? []), country]
        $save.dailyQuestProgress = {...$save.dailyQuestProgress, progress: progress}
    }

    onMount(async () => {
        successSound = new Audio((await import('$lib/assets/sounds/tap.wav')).default)

        $topojson = await import('$lib/assets/maps/topojson/optimized.json')
        $topojson = preprocessTopojson($topojson)
        $tags = getTags()
        $tags = _(getTags())
            .sort()
            .map(tag => ({name: tag, checked: tag === 'North America'}))
            .value()

        newDailyQuest()
    })

    function handleMousemove(e) {
        $mousePos = {x: e.clientX, y: e.clientY}
    }

    function handleKeypress(e) {
        if (dev && e.key === 'd') showDebug = !showDebug
    }
</script>

<svelte:window on:keypress={handleKeypress} on:mousemove={handleMousemove} bind:innerWidth={$clientX} bind:innerHeight={$clientY} />

{#if dev}
    <DebugInterface {mistakesThisGuess} {toFind} {unfoundFeatures} {showDebug} {projections} {lastFocusedCountry} bind:projection />
{/if}

<UI
    bind:this={ui}
    {questionFeature}
    {foundFeatures}
    {originalToFind}
    {mistakes}
    {correct}
    {restart}
    {newGame}
    {showWinScreen}
    {map}
    {streak}
    {newDailyQuest}
    {canRestart}
    {gameConfiguration}
    bind:interfaceLoaded
    bind:showMenu
/>

{#if $topojson && interfaceLoaded}
    <OlMap bind:this={map} topojson={$topojson} {projection} {clickCountryHandler} {countryFocusedHandler} {foundFeatures} {unfoundFeatures} {toFind} />
{/if}

{#if showLoadingScreen}
    <LoadingScreen />
{/if}

<MouseTooltip {focusedCountry} {unfoundFeatures} />
